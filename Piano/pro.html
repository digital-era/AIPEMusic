// ================= 优化的诗词文字呈现部分 =================
function initScrollHandler() {
    // 使用更轻量的IntersectionObserver
    if ('IntersectionObserver' in window) {
        const lines = document.querySelectorAll('.poem-line');
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('active');
                    // 只添加简单的active类，不添加文化光晕
                } else {
                    entry.target.classList.remove('active');
                }
            });
        }, {
            threshold: 0.3, // 30%可见时触发
            rootMargin: '0px 0px -20% 0px' // 优化触发区域
        });
        
        lines.forEach(line => observer.observe(line));
    } else {
        // 降级方案：简化滚动监听
        let ticking = false;
        const lines = document.querySelectorAll('.poem-line');
        
        function updateFocus() {
            const centerPoint = window.innerHeight / 2;
            
            lines.forEach(line => {
                const rect = line.getBoundingClientRect();
                const lineCenter = rect.top + rect.height / 2;
                const distance = Math.abs(centerPoint - lineCenter);
                
                // 更宽松的激活条件，减少频繁切换
                if (distance < 150) {
                    line.classList.add('active');
                } else {
                    line.classList.remove('active');
                }
            });
            
            ticking = false;
        }
        
        // 使用节流优化
        window.addEventListener('scroll', () => {
            if (!ticking) {
                requestAnimationFrame(updateFocus);
                ticking = true;
            }
        });
        
        updateFocus();
    }
}

// ================= 简化CSS样式（只修改诗词相关部分） =================
// 在原有CSS中添加以下简化样式：
<style>
    /* 简化.poem-line的样式 */
    .poem-line {
        font-size: 1.6rem;
        margin: 35px 0;
        color: rgba(255, 255, 255, 0.45);
        transition: color 0.4s ease, transform 0.4s ease;
        cursor: default;
        line-height: 1.8;
        position: relative;
        font-weight: 300;
        letter-spacing: 1px;
        will-change: transform; /* 性能优化 */
    }

    .poem-line.active {
        color: var(--gold-shine);
        transform: scale(1.03);
        font-weight: 400;
    }

    /* 移除所有复杂的光晕和背景效果 */
    .poem-line::before,
    .poem-line::after,
    .poem-line.active.highlight::after,
    .poem-line.active.highlight::before {
        display: none;
    }

    /* 移除所有滤镜和阴影效果 */
    .poem-line,
    .poem-line.active {
        filter: none !important;
        text-shadow: none !important;
        background: none !important;
        -webkit-background-clip: initial !important;
        background-clip: initial !important;
        -webkit-text-fill-color: initial !important;
    }

    /* 移除移动端的复杂效果 */
    @media (max-width: 600px) {
        .poem-line {
            font-size: 1.1rem;
            margin: 16px 0;
            line-height: 1.5;
        }
        
        .poem-line.active {
            transform: scale(1.01);
            color: var(--gold-shine);
            font-weight: 600;
        }
    }

    /* 简化标题和播放器动画 */
    .player-wrapper {
        transition: all 0.4s ease; /* 缩短动画时间 */
    }

    /* 简化副标题动画 */
    .subtitle {
        transition: all 0.3s ease;
    }
</style>

// ================= 添加播放时同步变色功能 =================
// 在JavaScript中添加以下代码：
<script>
    // 京剧版每行诗句的预估时间点（单位：秒）
    // 需要根据实际唱词调整这些时间
    const operaLineTimes = [
        0,    // 君不见，黄河之水天上来，奔流到海不复回。
        5,    // 君不见，高堂明镜悲白发，朝如青丝暮成雪。
        10,   // 人生得意须尽欢，莫使金樽空对月。
        15,   // 天生我材必有用，千金散尽还复来。
        20,   // 烹羊宰牛且为乐，会须一饮三百杯。
        25,   // 岑夫子，丹丘生，将进酒，杯莫停。
        30,   // 与君歌一曲，请君为我倾耳听。
        35,   // 钟鼓馔玉不足贵，但愿长醉不复醒。
        40,   // 古来圣贤皆寂寞，惟有饮者留其名。
        45,   // 陈王昔时宴平乐，斗酒十千恣欢谑。
        50,   // 主人何为言少钱，径须沽取对君酌。
        55,   // 五花马，千金裘，
        60    // 呼儿将出换美酒，与尔同销万古愁。
    ];

    // 钢琴版使用相同时间线（可根据需要调整）
    const pianoLineTimes = [...operaLineTimes];

    let currentLineTimes = pianoLineTimes;
    let timeUpdateInterval = null;

    // 更新播放时诗词变色逻辑
    function updateTrackForTimeSync() {
        currentLineTimes = currentTrack === 'piano' ? pianoLineTimes : operaLineTimes;
    }

    // 开始时间同步
    function startTimeSync() {
        if (timeUpdateInterval) {
            clearInterval(timeUpdateInterval);
        }
        
        timeUpdateInterval = setInterval(() => {
            if (!isPlaying) return;
            
            const currentTime = audio.currentTime;
            const lines = document.querySelectorAll('.poem-line');
            
            // 移除所有active状态
            lines.forEach(line => line.classList.remove('active'));
            
            // 找到当前时间对应的行
            for (let i = 0; i < currentLineTimes.length; i++) {
                if (currentTime >= currentLineTimes[i]) {
                    // 当前行及之前的所有行都激活（类似于卡拉OK效果）
                    for (let j = 0; j <= i; j++) {
                        if (lines[j]) lines[j].classList.add('active');
                    }
                }
            }
        }, 100); // 每100ms更新一次
    }

    // 停止时间同步
    function stopTimeSync() {
        if (timeUpdateInterval) {
            clearInterval(timeUpdateInterval);
            timeUpdateInterval = null;
        }
    }

    // 修改togglePlay函数
    function togglePlay() {
        if (!isSourceSet) {
            const filename = currentTrack === 'piano' ? TRACK_1_FILENAME : TRACK_2_FILENAME;
            audio.src = getResourceUrl(filename);
            isSourceSet = true;
        }

        if (isPlaying) {
            audio.pause();
            iconPlay.style.display = 'block';
            iconPause.style.display = 'none';
            spinner.style.display = 'none';
            isPlaying = false;
            stopTimeSync(); // 停止时间同步
        } else {
            iconPlay.style.display = 'none';
            spinner.style.display = 'block';
            
            // 更新时间线
            updateTrackForTimeSync();
            
            audio.play().then(() => {
                spinner.style.display = 'none';
                iconPause.style.display = 'block';
                isPlaying = true;
                startTimeSync(); // 开始时间同步
            }).catch(e => {
                console.error('播放错误:', e);
                spinner.style.display = 'none';
                iconPlay.style.display = 'block';
                showErrorToast('音频加载中，请稍候...');
            });
        }
    }

    // 修改switchTrack函数
    function switchTrack(trackType) {
        if (currentTrack === trackType) return;

        currentTrack = trackType;
        
        // 更新UI状态
        if (trackType === 'piano') {
            btnPiano.classList.add('active');
            btnOpera.classList.remove('active');
            animateSubtitleTransition("Ballade No. 1 in G minor, Op. 23");
        } else {
            btnOpera.classList.add('active');
            btnPiano.classList.remove('active');
            animateSubtitleTransition("Traditional Peking Opera Style");
        }

        // 切换音频源
        if (isPlaying) {
            stopTimeSync();
            stopAudio();
            isSourceSet = false;
            
            setTimeout(() => {
                updateTrackForTimeSync();
                togglePlay();
            }, 300);
        } else {
            isSourceSet = false;
        }
    }

    // 在DOMContentLoaded中添加初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 移除初始封面
        setTimeout(() => {
            const cover = document.getElementById('initial-cover');
            cover.style.opacity = '0';
            cover.style.transform = 'translateY(-20px)';
            
            setTimeout(() => {
                cover.style.display = 'none';
            }, 1500);
        }, 3000);

        // 初始化滚动监听
        initScrollHandler();
    });
</script>
